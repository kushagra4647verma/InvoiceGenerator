<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ORION Diamonds - Invoice Generator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: Arial, sans-serif;
        padding: 20px;
        background: #f5f6f7;
      }

      .title {
        text-align: center;
        margin-bottom: 20px;
        color: #333;
      }

      .form-container {
        background: white;
        padding: 30px;
        max-width: 900px;
        margin: auto;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }

      .form-group {
        margin-bottom: 15px;
      }

      .form-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: 600;
        color: #333;
      }

      .form-group input,
      .form-group textarea,
      .form-group select {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
      }

      .form-group textarea {
        resize: vertical;
        min-height: 60px;
      }

      .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
      }

      h3 {
        margin: 25px 0 15px 0;
        color: #333;
        border-bottom: 2px solid #333;
        padding-bottom: 8px;
      }

      .item-block {
        background: #f9f9f9;
        padding: 20px;
        margin-bottom: 20px;
        border-radius: 6px;
        border: 1px solid #e0e0e0;
      }

      .item-row {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 15px;
        margin-bottom: 12px;
      }

      .add-btn,
      .submit-btn {
        background: #333;
        color: white;
        padding: 12px 24px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 15px;
        font-weight: 600;
        transition: background 0.3s;
      }

      .add-btn:hover,
      .submit-btn:hover {
        background: #555;
      }

      .submit-btn {
        width: 100%;
        margin-top: 30px;
        padding: 15px;
        font-size: 16px;
      }

      .gst-option {
        margin: 20px 0;
        padding: 15px;
        background: #f0f0f0;
        border-radius: 5px;
      }

      .gst-option label {
        margin-right: 20px;
        font-weight: 600;
      }

      /* Invoice Styles */
      .invoice {
        width: 900px;
        margin: 50px auto;
        background: white;
        padding: 40px;
        border: 1px solid #ddd;
      }

      .inv-header {
        display: flex;
        justify-content: space-between;
        align-items: start;
        margin-bottom: 25px;
      }

      .inv-left h2 {
        font-size: 28px;
        margin-bottom: 10px;
      }

      .inv-left p {
        margin: 5px 0;
        font-size: 14px;
      }

      .logo {
        width: 130px;
      }

      .divider {
        border: none;
        border-top: 2px solid #333;
        margin: 20px 0;
      }

      .inv-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 20px;
      }

      .cust-table {
        width: 100%;
        margin: 20px 0;
        font-size: 14px;
      }

      .cust-table td {
        padding: 8px;
        vertical-align: top;
      }

      .cust-table b {
        color: #333;
      }

      /* New Table Styles */
      .item-table {
        width: 100%;
        border-collapse: collapse;
        margin: 25px 0;
        font-size: 13px;
      }

      .item-table thead th {
        background: #333;
        color: white;
        padding: 12px 8px;
        text-align: left;
        font-weight: 600;
        border: 1px solid #333;
      }

      .item-table td {
        padding: 10px 8px;
        border: 1px solid #ddd;
      }

      .item-table tr:nth-child(even) {
        background: #f9f9f9;
      }

      .summary-section {
        display: flex;
        justify-content: flex-end;
        margin-top: 30px;
      }

      .gst-table {
        width: 400px;
        border-collapse: collapse;
        font-size: 14px;
      }

      .gst-table td {
        padding: 10px 15px;
        border-bottom: 1px solid #ddd;
      }

      .gst-table td:first-child {
        font-weight: 600;
        color: #555;
      }

      .gst-table td:last-child {
        text-align: right;
        font-weight: 500;
      }

      .gst-table .grand-total td {
        border-top: 2px solid #333;
        border-bottom: 2px solid #333;
        font-size: 16px;
        font-weight: 700;
        padding: 12px 15px;
        background: #f0f0f0;
      }

      .footer {
        display: flex;
        justify-content: space-between;
        margin-top: 50px;
        padding-top: 20px;
        border-top: 1px solid #ddd;
      }

      .bank-box h3 {
        font-size: 16px;
        margin-bottom: 10px;
        border: none;
        padding: 0;
      }

      .bank-box p {
        margin: 5px 0;
        font-size: 14px;
      }

      .sign-box {
        text-align: right;
      }

      .stamp-crop {
        width: 120px;
        height: 136px;
        overflow: hidden;
        position: relative;
        margin-left: auto;
        margin-bottom: 10px;
      }

      .stamp-img {
        width: 120px;
        opacity: 0.85;
      }

      .sign-box p {
        margin: 5px 0;
        font-size: 14px;
      }
    </style>
  </head>

  <body>
    <h2 class="title">ORION Diamonds – Invoice Generator</h2>

    <div class="form-container">
      <div class="form-row">
        <div class="form-group">
          <label>Customer Name:</label>
          <input id="custName" oninput="updateInvoice()" />
        </div>
        <div class="form-group">
          <label>Customer Mobile:</label>
          <input id="custMobile" oninput="updateInvoice()" />
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label>Billing Address:</label>
          <textarea id="billAddr" oninput="updateInvoice()"></textarea>
        </div>
        <div class="form-group">
          <label>Shipping Address:</label>
          <textarea id="shipAddr" oninput="updateInvoice()"></textarea>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label>Invoice Number:</label>
          <input id="invoiceNum" oninput="updateInvoice()" />
        </div>
        <div class="form-group">
          <label>Invoice Date:</label>
          <input type="date" id="invoiceDate" oninput="updateInvoice()" />
        </div>
      </div>

      <h3>Item Details</h3>

      <div id="itemContainer"></div>

      <button type="button" class="add-btn" onclick="addItem()">
        + Add Item
      </button>

      <div class="gst-option">
        <label>GST Type:</label>
        <label>
          <input
            type="radio"
            name="gstType"
            value="cgst_sgst"
            checked
            onchange="updateInvoice()"
          />
          CGST (1.5%) + SGST (1.5%)
        </label>
        <label>
          <input
            type="radio"
            name="gstType"
            value="igst"
            onchange="updateInvoice()"
          />
          IGST (3%)
        </label>
      </div>

      <button class="submit-btn" onclick="generatePDF()">
        Generate & Download PDF
      </button>
    </div>

    <!-- ================= INVOICE TEMPLATE =================== -->

    <div id="invoice" class="invoice">
      <div class="inv-header">
        <div class="inv-left">
          <h2>ORION DIAMONDS</h2>
          <p>GSTIN: 27BRDPJ6385G1ZJ</p>
          <p>
            GAT NO 331-338, Plot No. 2, Near BJP Market, Tal Hatkanangale,<br />
            Ichalkaranji, Kolhapur, Maharashtra - 416115
          </p>
          <p>Mobile: 7022253092</p>
          <p>Email: info@oriondiamonds.in</p>
        </div>

        <div class="inv-right">
          <img src="logo.jpg" class="logo" alt="Logo" />
        </div>
      </div>

      <hr class="divider" />

      <div class="inv-row">
        <div>
          <p><b>Invoice No:</b> <span id="out_invoiceNum"></span></p>
        </div>
        <div>
          <p><b>Invoice Date:</b> <span id="out_invoiceDate"></span></p>
        </div>
      </div>

      <table class="cust-table" id="cust_table_wrapper">
        <tr id="row1" style="display: none">
          <td width="15%"><b>Customer Name:</b></td>
          <td width="35%" id="out_custName"></td>
          <td width="15%" id="bill_label"><b>Billing Address:</b></td>
          <td width="35%" id="out_billAddr"></td>
        </tr>
        <tr id="row2" style="display: none">
          <td><b>Contact:</b></td>
          <td id="out_custMobile"></td>
          <td id="ship_label"><b>Shipping Address:</b></td>
          <td id="out_shipAddr"></td>
        </tr>
      </table>

      <table class="item-table">
        <thead>
          <tr>
            <th>Item</th>
            <th>Gold Purity/Karat</th>
            <th>Gold Weight (g)</th>
            <th>Gold Total Value</th>
            <th>Gold Making Charges</th>
            <th>Diamond Total Carats</th>
            <th>Diamond Total Value</th>
            <th>Total Price</th>
          </tr>
        </thead>
        <tbody id="item_out"></tbody>
      </table>

      <div class="summary-section">
        <table class="gst-table">
          <tr>
            <td>Subtotal</td>
            <td id="out_subtotal">₹0.00</td>
          </tr>
          <tr id="cgst_row">
            <td>CGST (1.5%)</td>
            <td id="out_cgst">₹0.00</td>
          </tr>
          <tr id="sgst_row">
            <td>SGST (1.5%)</td>
            <td id="out_sgst">₹0.00</td>
          </tr>
          <tr id="igst_row" style="display: none">
            <td>IGST (3%)</td>
            <td id="out_igst">₹0.00</td>
          </tr>
          <tr class="grand-total">
            <td>Grand Total</td>
            <td id="out_total">₹0.00</td>
          </tr>
        </table>
      </div>

      <div class="footer">
        <div class="bank-box">
          <h3>Bank Details</h3>
          <p>Ac No: 925020038972487</p>
          <p>IFSC: UTIB0000606</p>
          <p>Bank: Axis Bank</p>
          <p>Branch: Ichalkaranji</p>
        </div>

        <div class="sign-box">
          <div class="stamp-crop">
            <img src="stamporg.png" class="stamp-img" alt="Stamp" />
          </div>
          <p>__________________________</p>
          <p>Authorized Signatory</p>
        </div>
      </div>
    </div>

    <script>
      let invoiceCounter = 1;

      function generateInvoiceNumber() {
        const d = new Date();
        return `${d.getMonth() + 1}-${d.getFullYear()}-${invoiceCounter}`;
      }

      // Format number in Indian currency style
      function formatIndianCurrency(num) {
        const n = parseFloat(num) || 0;
        return (
          "₹" +
          n.toLocaleString("en-IN", {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2,
          })
        );
      }

      // Clean and parse currency input
      function parseAmount(value) {
        if (!value) return 0;
        // Remove ₹ symbol, commas, and spaces
        const cleaned = String(value).replace(/[₹,\s]/g, "");
        return parseFloat(cleaned) || 0;
      }

      // Set initial invoice number
      document.getElementById("invoiceNum").value = generateInvoiceNumber();

      // Set today's date
      const today = new Date().toISOString().split("T")[0];
      document.getElementById("invoiceDate").value = today;

      // Add first item by default
      addItem();

      function addItem() {
        const container = document.getElementById("itemContainer");
        const itemHTML = `
          <div class="item-block">
            <div class="item-row">
              <div class="form-group">
                <label>Item Name:</label>
                <input class="itemName" oninput="updateInvoice()" />
              </div>
              <div class="form-group">
                <label>Gold Purity/Karat:</label>
                <select class="goldPurity" onchange="updateInvoice()">
                  <option value="9kt">9kt</option>
                  <option value="18kt">18kt</option>
                  <option value="22kt">22kt</option>
                  <option value="14kt">14kt</option>
                  <option value="24kt">24kt</option>
                </select>
              </div>
              <div class="form-group">
                <label>Gold Weight (g):</label>
                <input type="text" class="goldWeight" oninput="updateInvoice()" placeholder="0.00" />
              </div>
            </div>

            <div class="item-row">
              <div class="form-group">
                <label>Gold Total Value (₹):</label>
                <input type="text" class="goldValue" oninput="updateInvoice()" placeholder="₹0.00" />
              </div>
              <div class="form-group">
                <label>Gold Making Charges (₹):</label>
                <input type="text" class="makingCharges" oninput="updateInvoice()" placeholder="₹0.00" />
              </div>
              <div class="form-group">
                <label>Diamond Total Carats:</label>
                <input type="text" class="diamondCarats" oninput="updateInvoice()" placeholder="0.00" />
              </div>
            </div>

            <div class="item-row">
              <div class="form-group">
                <label>Diamond Total Value (₹):</label>
                <input type="text" class="diamondValue" oninput="updateInvoice()" placeholder="₹0.00" />
              </div>
            </div>
          </div>
        `;
        container.insertAdjacentHTML("beforeend", itemHTML);
        updateInvoice();
      }

      function updateInvoice() {
        // Update basic details
        document.getElementById("out_invoiceNum").textContent =
          document.getElementById("invoiceNum").value;
        document.getElementById("out_invoiceDate").textContent =
          document.getElementById("invoiceDate").value;

        // Get values
        const custName = document.getElementById("custName").value.trim();
        const custMobile = document.getElementById("custMobile").value.trim();
        const billAddr = document.getElementById("billAddr").value.trim();
        const shipAddr = document.getElementById("shipAddr").value.trim();

        // Update content
        document.getElementById("out_custName").textContent = custName;
        document.getElementById("out_custMobile").textContent = custMobile;
        document.getElementById("out_billAddr").textContent = billAddr;
        document.getElementById("out_shipAddr").textContent = shipAddr;

        // Check if any field in row 1 has data
        const row1HasData = custName || billAddr;
        // Check if any field in row 2 has data
        const row2HasData = custMobile || shipAddr;

        // Show/hide rows based on data
        document.getElementById("row1").style.display = row1HasData
          ? ""
          : "none";
        document.getElementById("row2").style.display = row2HasData
          ? ""
          : "none";

        // Hide entire customer table if no data
        const custTableWrapper = document.getElementById("cust_table_wrapper");
        if (!row1HasData && !row2HasData) {
          custTableWrapper.style.display = "none";
        } else {
          custTableWrapper.style.display = "";
        }

        // Hide labels if corresponding fields are empty
        document.getElementById("bill_label").style.display = billAddr
          ? ""
          : "none";
        document.getElementById("ship_label").style.display = shipAddr
          ? ""
          : "none";

        // Collect all item data
        const itemNames = [...document.querySelectorAll(".itemName")].map(
          (i) => i.value
        );
        const goldPurity = [...document.querySelectorAll(".goldPurity")].map(
          (i) => i.value
        );
        const goldWeight = [...document.querySelectorAll(".goldWeight")].map(
          (i) => parseAmount(i.value)
        );
        const goldValue = [...document.querySelectorAll(".goldValue")].map(
          (i) => parseAmount(i.value)
        );
        const makingCharges = [
          ...document.querySelectorAll(".makingCharges"),
        ].map((i) => parseAmount(i.value));
        const diamondCarats = [
          ...document.querySelectorAll(".diamondCarats"),
        ].map((i) => parseAmount(i.value));
        const diamondValue = [
          ...document.querySelectorAll(".diamondValue"),
        ].map((i) => parseAmount(i.value));

        let tableHTML = "";
        let subtotal = 0;

        // Build item table
        for (let i = 0; i < itemNames.length; i++) {
          const totalPrice = goldValue[i] + makingCharges[i] + diamondValue[i];
          subtotal += totalPrice;

          tableHTML += `
            <tr>
              <td>${itemNames[i] || "-"}</td>
              <td>${goldPurity[i]}</td>
              <td>${goldWeight[i].toFixed(2)}</td>
              <td>${formatIndianCurrency(goldValue[i])}</td>
              <td>${formatIndianCurrency(makingCharges[i])}</td>
              <td>${diamondCarats[i].toFixed(2)}</td>
              <td>${formatIndianCurrency(diamondValue[i])}</td>
              <td><b>${formatIndianCurrency(totalPrice)}</b></td>
            </tr>
          `;
        }

        document.getElementById("item_out").innerHTML = tableHTML;

        // Calculate GST based on selected type
        const gstType = document.querySelector(
          'input[name="gstType"]:checked'
        ).value;
        let cgst = 0,
          sgst = 0,
          igst = 0;

        if (gstType === "cgst_sgst") {
          cgst = subtotal * 0.015;
          sgst = subtotal * 0.015;
          document.getElementById("cgst_row").style.display = "";
          document.getElementById("sgst_row").style.display = "";
          document.getElementById("igst_row").style.display = "none";
        } else {
          igst = subtotal * 0.03;
          document.getElementById("cgst_row").style.display = "none";
          document.getElementById("sgst_row").style.display = "none";
          document.getElementById("igst_row").style.display = "";
        }

        const total = subtotal + cgst + sgst + igst;

        // Update summary table
        document.getElementById("out_subtotal").textContent =
          formatIndianCurrency(subtotal);
        document.getElementById("out_cgst").textContent =
          formatIndianCurrency(cgst);
        document.getElementById("out_sgst").textContent =
          formatIndianCurrency(sgst);
        document.getElementById("out_igst").textContent =
          formatIndianCurrency(igst);
        document.getElementById("out_total").textContent =
          formatIndianCurrency(total);
      }

      function generatePDF() {
        html2canvas(document.getElementById("invoice"), {
          scale: 1.5, // Reduced from 2 to 1.5 for smaller file size
          useCORS: true,
          logging: false,
          imageTimeout: 0,
        }).then((canvas) => {
          // Convert to JPEG with compression instead of PNG
          const imgData = canvas.toDataURL("image/jpeg", 0.85); // 0.85 quality (85%)
          const pdf = new jspdf.jsPDF("p", "mm", "a4");

          const pdfWidth = 210;
          const pdfHeight = (canvas.height * pdfWidth) / canvas.width;

          // Use JPEG instead of PNG for smaller size
          pdf.addImage(imgData, "JPEG", 0, 0, pdfWidth, pdfHeight);

          // Compress the PDF
          pdf.save(
            `Invoice-${document.getElementById("invoiceNum").value}.pdf`,
            {
              compress: true,
            }
          );

          // Increment counter and generate new invoice number
          invoiceCounter++;
          document.getElementById("invoiceNum").value = generateInvoiceNumber();
          updateInvoice();
        });
      }

      // Initial update
      updateInvoice();
    </script>
  </body>
</html>
